const express = require("express"); const router = express.Router(); let merchants = []; router.post("/whatsapp", async (req, res) => { try { console.log("ðŸ“¥ Received WhatsApp webhook:", req.body); const { From, Body, MessageSid } = req.body; const phoneNumber = From; const message = Body; if (!phoneNumber || !message) { return res.status(400).json({ error: "Missing phone number or message" }); } let merchant = merchants.find(m => m.whatsappNumber === phoneNumber); if (!merchant) { merchant = { id: `merchant-${Date.now()}`, whatsappNumber: phoneNumber, companyName: "Unknown", onboardingStep: "welcome", status: "not_started", createdAt: new Date(), conversationHistory: [] }; merchants.push(merchant); console.log(`ðŸŽ‰ New merchant started: ${phoneNumber}`); } console.log(`ðŸ“¤ Would send WhatsApp response to: ${phoneNumber}`); console.log(`ðŸ“ Message: ${message}`); res.status(200).json({ success: true, message: "Webhook processed", phoneNumber: phoneNumber, receivedMessage: message, merchantId: merchant.id }); } catch (error) { console.error("âŒ Webhook error:", error); res.status(500).json({ error: "Internal server error" }); } }); router.get("/status", (req, res) => { res.json({ status: "active", merchants: merchants.length, endpoint: "/api/webhook/whatsapp" }); }); module.exports = router;
